<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Plan de classe 403</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f8f8f8;
      padding: 20px;
      text-align: center;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(3, 160px);
      gap: 20px 50px;
      justify-content: center;
    }
    .cell { position: relative; }
    .half {
      position: relative;
      width: 160px; height: 60px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-shadow: 1px 1px 4px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px; font-weight: bold;
      cursor: pointer;
      user-select: none;
      transition: background-color .2s;
      margin-bottom: 10px;
    }
    .half.active { background-color: #c8facc; }
    .toggle-notes {
      position: absolute; top: 4px; right: 4px;
      width: 14px; height: 14px;
      cursor: pointer; z-index: 10;
    }
    .notes-options {
      display: none;
      position: absolute; top: 22px; right: 4px;
      background: #fff; border: 1px solid #aaa;
      border-radius: 4px; box-shadow: 2px 2px 6px rgba(0,0,0,.1);
      padding: 4px 8px; font-size: 12px;
      text-align: left; z-index: 9;
    }
    .notes-options label { display: block; margin-bottom: 2px; }
    .context-menu {
      position: absolute; display: none;
      background: #fff; border: 1px solid #aaa;
      box-shadow: 2px 2px 5px rgba(0,0,0,.2);
      z-index: 1000; font-size: 13px;
    }
    .context-menu .menu-option {
      padding: 6px 12px; cursor: pointer;
    }
    .context-menu .menu-option.selected {
      background-color: #d0ebff;
    }
    .footer-layout {
      display: flex; justify-content: center; align-items: center;
      margin-top: 50px; position: relative;
    }
    .left-button {
      position: absolute; left: 20px; top: 80px; text-align: left;
    }
    .bouton, .tableau, .export-btn {
      width: 200px; height: 40px;
      background: #e0e0e0; border: 2px solid #666;
      border-radius: 6px; display: flex;
      align-items: center; justify-content: center;
      font-weight: bold; font-size: 16px;
      box-shadow: 2px 2px 6px rgba(0,0,0,.2);
      cursor: pointer; margin-top: 10px;
    }
    #presence-count {
      font-size: 14px; font-weight: bold;
      margin-bottom: 8px; color: #222;
    }
    #presence-result, #feedback {
      font-size: 14px; color: #222; text-align: left;
      position: absolute; width:200px;
    }
    #presence-result { left:20px; top:140px; }
    #feedback         { right:20px; top:100px; }
  </style>
</head>
<body>
  <h1>Plan de classe 403</h1>

  <div class="grid">
    <!-- Exemple pour cases 1–2, dupliquez jusqu'à case 30 -->
    <div class="cell">
      <div class="half">case 1
        <input type="checkbox" class="toggle-notes">
        <div class="notes-options">
          <label><input type="checkbox" value="Comportement"> Comportement</label>
          <label><input type="checkbox" value="Travail non fait"> Travail non fait</label>
          <label><input type="checkbox" value="Oubli de matériel"> Oubli de matériel</label>
        </div>
      </div>
      <div class="half">case 2
        <input type="checkbox" class="toggle-notes">
        <div class="notes-options">
          <label><input type="checkbox" value="Comportement"> Comportement</label>
          <label><input type="checkbox" value="Travail non fait"> Travail non fait</label>
          <label><input type="checkbox" value="Oubli de matériel"> Oubli de matériel</label>
        </div>
      </div>
    </div>
    <!-- … jusqu’à case 30 -->
  </div>

  <div class="footer-layout">
    <div class="left-button">
      <div id="presence-count"></div>
      <div class="bouton" onclick="afficherAppel()">Appel terminé</div>
      <div class="export-btn" onclick="exportState()">Exporter l’état</div>
      <input type="file" id="import-file" style="display:none" accept="application/json"
             onchange="importState(event)">
      <div class="export-btn" onclick="document.getElementById('import-file').click()">
        Importer l’état
      </div>
    </div>
    <div class="tableau">Tableau</div>
  </div>

  <div id="context-menu" class="context-menu">
    <div class="menu-option">Comportement</div>
    <div class="menu-option">Travail non fait</div>
    <div class="menu-option">Oubli de matériel</div>
  </div>
  <div id="presence-result"></div>
  <div id="feedback"></div>

  <script>
    // ----- context menu
    let caseCible = null;
    const menu = document.getElementById("context-menu"),
          opts = menu.querySelectorAll(".menu-option");
    let selectedIndex = 0;

    function selectOption(i) {
      opts.forEach((o,j)=>o.classList.toggle('selected', i===j));
      selectedIndex = i;
    }
    function openContextMenu(target) {
      caseCible = target;
      const r = target.getBoundingClientRect();
      menu.style.left = `${r.right+5+window.scrollX}px`;
      menu.style.top  = `${r.top+window.scrollY}px`;
      menu.style.display = 'block';
      selectOption(0);
    }
    document.body.addEventListener('click', e=>{
      if(!menu.contains(e.target)) menu.style.display='none';
    });
    opts.forEach((opt,i)=>{
      opt.addEventListener('click', ()=>{
        if(!caseCible) return;
        afficherFeedback(caseCible, opt.textContent);
        menu.style.display='none';
        saveState();
      });
    });

    // ----- gestion notes
    document.querySelectorAll('.toggle-notes').forEach(cb=>{
      cb.addEventListener('change', ()=>{
        const no = cb.parentElement.querySelector('.notes-options');
        no.style.display = cb.checked ? 'block' : 'none';
        saveState();
      });
    });

    // ----- toggle présence / long-press
    document.querySelectorAll('.half').forEach(half=>{
      let timer, longPress=false;
      half.addEventListener('mousedown',()=>{
        longPress=false;
        timer = setTimeout(()=>{
          longPress=true;
          openContextMenu(half);
        }, 500);
      });
      half.addEventListener('touchstart', e=>{
        e.preventDefault();
        longPress=false;
        timer = setTimeout(()=>{
          longPress=true;
          openContextMenu(half);
        }, 500);
      });
      function upHandler(){
        clearTimeout(timer);
        if(!longPress){
          half.classList.toggle('active');
          saveState();
        }
      }
      half.addEventListener('mouseup', upHandler);
      half.addEventListener('touchend', upHandler);
      half.addEventListener('mouseleave', ()=> clearTimeout(timer));
    });

    // ----- fonction appel
    function afficherAppel(){
      const halves = Array.from(document.querySelectorAll('.half'));
      const presCount = halves.filter(h=>h.classList.contains('active')).length;
      document.getElementById('presence-count').textContent = `Présents : ${presCount}`;

      const abs = halves.filter(h=>!h.classList.contains('active'))
                .map(h=>h.childNodes[0].textContent.trim());
      const uniq = [...new Set(abs)];
      document.getElementById('presence-result').innerHTML =
        `<div><strong>Absents (${uniq.length}) :</strong> ${uniq.join(', ')}</div>`;
    }

    // ----- feedback
    function afficherFeedback(el, remark){
      const name = el.childNodes[0].textContent.trim();
      const d = document.createElement('div');
      d.innerHTML = `<strong>${name}</strong> : ${remark}`;
      document.getElementById('feedback').appendChild(d);
    }

    // ----- export/import JSON
    function getState(){
      const s = {};
      document.querySelectorAll('.half').forEach(h=>{
        const name = h.childNodes[0].textContent.trim();
        const notes = [...h.querySelectorAll('.notes-options input:checked')]
                      .map(cb=>cb.value);
        s[name] = {
          active: h.classList.contains('active'),
          showNotes: h.querySelector('.toggle-notes').checked,
          notes
        };
      });
      return s;
    }
    function applyState(s){
      Object.entries(s).forEach(([name,st])=>{
        const h = [...document.querySelectorAll('.half')]
                  .find(xx=>xx.childNodes[0].textContent.trim()===name);
        if(!h) return;
        h.classList.toggle('active', st.active);
        const cbNotes = h.querySelector('.toggle-notes');
        cbNotes.checked = st.showNotes;
        const no = h.querySelector('.notes-options');
        no.style.display = st.showNotes ? 'block':'none';
        h.querySelectorAll('.notes-options input').forEach(i=>{
          i.checked = st.notes.includes(i.value);
        });
      });
    }
    function exportState(){
      const data = JSON.stringify(getState(), null, 2);
      const blob = new Blob([data],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'etat_plan.json'; a.click();
      URL.revokeObjectURL(url);
    }
    function importState(evt){
      const f = evt.target.files[0];
      if(!f) return;
      const rdr = new FileReader();
      rdr.onload = e=>{
        try{
          const obj = JSON.parse(e.target.result);
          applyState(obj);
          saveState();
          alert('État importé avec succès');
        }catch{
          alert('Fichier JSON invalide');
        }
      };
      rdr.readAsText(f);
    }

    // ----- persistence auto via localStorage
    function saveState(){
      localStorage.setItem('plan403', JSON.stringify(getState()));
    }
    function loadState(){
      const txt = localStorage.getItem('plan403');
      if(txt) {
        try { applyState(JSON.parse(txt)); }
        catch{}
      }
    }
    window.addEventListener('load', loadState);
    window.addEventListener('beforeunload', saveState);
  </script>
</body>
</html>
