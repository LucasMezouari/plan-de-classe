<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Plan de classe 403</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .container { display: flex; gap: 20px; align-items: flex-start; }

    /* Boîte “Lien” */
    .lien-box {
      flex: none; width: 80px; padding: 10px;
      background-color: #87CEEB; border-radius: 5px;
      text-align: center; cursor: pointer; user-select: none;
    }
    .lien-box:hover { background-color: #00bfff; }

    /* Grille : 3 conteneurs × 5 lignes */
    .cases {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }

    /* Chaque conteneur regroupe deux sous-cases */
    .case-container {
      display: flex;
      background-color: #87CEEB;
      border-radius: 5px;
      overflow: hidden;
    }

    /* Une vraie sous-case (maintenant sans toggle au clic) */
    .subcase {
      flex: 1;
      padding: 8px;
      position: relative;
      border-right: 1px solid rgba(255,255,255,0.7);
    }
    .subcase:last-child {
      border-right: none;
    }

    /* Checkbox de bascule + titre inline */
    .subcase .header {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .subcase .header .toggle {
      cursor: pointer;
    }
    .subcase .header .title {
      font-weight: bold;
    }

    /* Options cachées, affichées si la toggle est cochée */
    .subcase .options {
      margin-top: 8px;
      display: none;
      padding-left: 4px;
    }
    .subcase .toggle:checked ~ .options {
      display: block;
    }

    /* Souligne la sous-case lorsque toggle est cochée */
    .subcase .toggle:checked + .title,
    .subcase .toggle:checked { 
      background-color: #006400;
      color: #fff;
    }

    /* Zone des résultats */
    .result {
      flex: 1; padding: 10px;
      border: 1px solid #ccc; border-radius: 5px;
      min-width: 200px;
    }
    #result-list {
      list-style: none; padding: 0; margin: 0;
    }
    #result-list li { margin-bottom: 5px; }
  </style>
</head>
<body>

  <div class="container">
    <!-- 1) Boîte “Lien” -->
    <div class="lien-box" id="lien-box">Lien</div>

    <!-- 2) Grille vide -->
    <div class="cases" id="cases"></div>

    <!-- 3) Zone de résultats -->
    <div class="result">
      <ul id="result-list"></ul>
    </div>
  </div>

  <script>
    // Génération dynamique de 3×5 containers → 30 sous-cases
    const casesContainer = document.getElementById('cases');
    let num = 1;
    for (let row = 0; row < 5; row++) {
      for (let col = 0; col < 3; col++) {
        const container = document.createElement('div');
        container.className = 'case-container';
        for (let half = 0; half < 2; half++) {
          const sc = document.createElement('div');
          sc.className = 'subcase';
          sc.dataset.case = num;

          // Header : toggle + titre
          const header = document.createElement('div');
          header.className = 'header';
          const toggle = document.createElement('input');
          toggle.type = 'checkbox';
          toggle.className = 'toggle';
          toggle.dataset.case = num;
          const title = document.createElement('span');
          title.className = 'title';
          title.textContent = `Case ${num}`;
          header.appendChild(toggle);
          header.appendChild(title);
          sc.appendChild(header);

          // Bloc des options
          const opts = document.createElement('div');
          opts.className = 'options';
          ['Comportement','Travail non fait','Oubli de matériel']
            .forEach(val => {
              const lbl = document.createElement('label');
              const inp = document.createElement('input');
              inp.type = 'checkbox';
              inp.dataset.case = num;
              inp.value = val;
              lbl.appendChild(inp);
              lbl.appendChild(document.createTextNode(' ' + val));
              opts.appendChild(lbl);
              opts.appendChild(document.createElement('br'));
            });
          sc.appendChild(opts);

          container.appendChild(sc);
          num++;
        }
        casesContainer.appendChild(container);
      }
    }

    // 1) Gestion des options à l’intérieur des sous-cases
    document.querySelectorAll('.options input[type="checkbox"]').forEach(cb => {
      cb.addEventListener('change', function() {
        const c = this.dataset.case;
        this.checked ? addResult(c, this.value) : removeResult(c, this.value);
      });
    });

    // 2) Fonctions d’ajout / suppression dans la zone Résultats
    const resultList = document.getElementById('result-list');
    function addResult(c, v) {
      const id = `result-${c}-${v}`;
      if (!document.getElementById(id)) {
        const li = document.createElement('li');
        li.id = id;
        li.textContent = `case n°${c} : ${v}`;
        resultList.appendChild(li);
      }
    }
    function removeResult(c, v) {
      const el = document.getElementById(`result-${c}-${v}`);
      if (el) el.remove();
    }

    // 3) Clic sur “Lien” → collecte, JSON & téléchargement/fallback
    document.getElementById('lien-box').addEventListener('click', () => {
      const infractions = Array.from(
        document.querySelectorAll('#result-list li')
      ).map(li => li.textContent);

      // date Paris JJ-MM-HHhMM
      const lok = new Intl.DateTimeFormat('fr-FR', {
        timeZone: 'Europe/Paris',
        year:   'numeric', month: '2-digit',
        day:    '2-digit', hour:  '2-digit',
        minute: '2-digit'
      }).format(new Date());
      const [dp, tp] = lok.split(' ');
      const [jj,MM] = dp.split('/');
      const [hh,mm] = tp.split(':');
      const now = `${jj}-${MM}-${hh}h${mm}`;

      const payload = { date: now + ' (Europe/Paris)', infractions };
      const data    = JSON.stringify(payload, null, 2);

      const blob = new Blob([data], { type: 'application/json' });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');

      if ('download' in a) {
        a.href     = url;
        a.download = `infractions_${now}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } else {
        window.open(url);
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      }
    });
  </script>
</body>
</html>
