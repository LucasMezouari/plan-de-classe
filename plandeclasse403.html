<script>
  // Variables globales
  let caseCible = null;
  const menu = document.getElementById("context-menu");
  const options = menu.querySelectorAll(".menu-option");
  let selectedIndex = 0;

  // --- Menu contextuel clavier/souris ---
  function selectOption(index) {
    options.forEach((opt, i) => opt.classList.toggle('selected', i === index));
    selectedIndex = index;
  }

  function openContextMenu(target) {
    caseCible = target;
    const rect = target.getBoundingClientRect();
    menu.style.left = `${rect.right + window.scrollX + 5}px`;
    menu.style.top = `${rect.top + window.scrollY}px`;
    menu.style.display = 'block';
    selectOption(0);
  }

  document.body.addEventListener('click', e => {
    if (!menu.contains(e.target)) menu.style.display = 'none';
  });

  options.forEach((opt, i) => {
    opt.addEventListener('click', () => {
      if (!caseCible) return;
      afficherFeedback(caseCible.textContent.trim(), opt.textContent);
      menu.style.display = 'none';
    });
  });

  document.addEventListener('keydown', e => {
    if (menu.style.display !== 'block') return;
    if (e.key === 'ArrowDown') {
      selectOption((selectedIndex + 1) % options.length);
      e.preventDefault();
    } else if (e.key === 'ArrowUp') {
      selectOption((selectedIndex - 1 + options.length) % options.length);
      e.preventDefault();
    } else if (e.key === 'Enter') {
      const texte = options[selectedIndex].textContent;
      afficherFeedback(caseCible.textContent.trim(), texte);
      menu.style.display = 'none';
    }
  });

  // --- Clic simple / long-press sur chaque moitié de case ---
  document.querySelectorAll('.half').forEach(half => {
    let timer, isLongPress = false;

    half.addEventListener('mousedown', () => {
      isLongPress = false;
      timer = setTimeout(() => {
        isLongPress = true;
        openContextMenu(half);
      }, 500);
    });
    half.addEventListener('touchstart', e => {
      e.preventDefault();
      isLongPress = false;
      timer = setTimeout(() => {
        isLongPress = true;
        openContextMenu(half);
      }, 500);
    });
    half.addEventListener('mouseup', () => {
      clearTimeout(timer);
      if (!isLongPress) half.classList.toggle('active');
    });
    half.addEventListener('touchend', () => {
      clearTimeout(timer);
      if (!isLongPress) half.classList.toggle('active');
    });
    half.addEventListener('mouseleave', () => clearTimeout(timer));
  });

  // --- Affichage des remarques sous "#feedback" ---
  function afficherFeedback(nom, remarque) {
    const div = document.getElementById("feedback");
    const ligne = document.createElement("div");
    ligne.innerHTML = `<strong>${nom}</strong> : ${remarque}`;
    div.appendChild(ligne);
  }

  // --- Comptage des présences sous "#presence-result" ---
  function afficherAppel() {
    const allHalves = Array.from(document.querySelectorAll('.half'));
    const presents = allHalves.filter(h => h.classList.contains('active'));
    const absents  = allHalves.filter(h => !h.classList.contains('active'));
    const presNames = [...new Set(presents.map(h => h.textContent.trim()))];
    const absNames  = [...new Set(absents.map(h => h.textContent.trim()))];
    const resultDiv = document.getElementById('presence-result');
    resultDiv.innerHTML = `
      <div><strong>Présents (${presNames.length}) :</strong> ${presNames.join(', ')}</div>
      <div style="margin-top: 8px;"><strong>Absents (${absNames.length}) :</strong> ${absNames.join(', ')}</div>
    `;
  }

  // --- Gestion de la checkbox de notes ---
  document.querySelectorAll('.toggle-notes').forEach(cb => {
    cb.addEventListener('change', () => {
      const opts = cb.parentElement.querySelector('.notes-options');
      opts.style.display = cb.checked ? 'block' : 'none';
    });
  });
</script>
