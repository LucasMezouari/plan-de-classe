<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Plan de classe 403</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .container { display: flex; gap: 20px; align-items: flex-start; }

    /* Colonne de gauche */
    .left-panel {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .lien-box {
      width: 120px;
      padding: 10px;
      background-color: #87CEEB;
      border-radius: 5px;
      text-align: center;
      cursor: pointer;
      user-select: none;
    }
    .lien-box:hover { background-color: #00bfff; }

    /* Grille 3×5 de sous-cases */
    .cases {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }
    .case-container {
      display: flex;
      background-color: #87CEEB;
      border-radius: 5px;
      overflow: hidden;
    }
    .subcase {
      flex: 1;
      padding: 8px;
      border-right: 1px solid rgba(255,255,255,0.7);
      cursor: pointer;
    }
    .subcase:last-child { border-right: none; }
    .subcase.selected {
      background-color: #006400;
      color: #fff;
    }

    .header {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .toggle { cursor: pointer; }
    .title { font-weight: bold; }

    .options {
      margin-top: 8px;
      display: none;
      padding-left: 4px;
    }

    .result {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      min-width: 200px;
    }
    #result-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #result-list li {
      margin-bottom: 5px;
      cursor: pointer;
    }
    /* style détail */
    #result-list li.detail {
      font-style: italic;
      padding-left: 20px;
      margin-bottom: 10px;
      cursor: default;
    }
    #result-list li.detail-select {
      padding-left: 20px;
      margin-bottom: 10px;
    }
    #result-list li.detail-select select,
    #result-list li.detail-select button {
      margin-right: 5px;
    }
  </style>
</head>
<body>

  <div class="container">
    <div class="left-panel">
      <div class="lien-box" id="lien-box">Lien</div>
      <div class="lien-box" id="appel-box">Appel terminé</div>
      <div id="appel-result"></div>
    </div>

    <div class="cases" id="cases"></div>

    <div class="result">
      <ul id="result-list"></ul>
    </div>
  </div>

  <script>
    // précisions possibles
    const detailsOptions = {
      "Comportement": [
        "Insultes envers le professeur",
        "Insulte envers un camarade",
        "Insolence"
      ],
      "Travail non fait": [
        "Copie blanche",
        "Ne sors aucune affaire"
      ],
      "Oubli de matériel": [
        "Oubli de calculatrice",
        "Oubli de cahier",
        "Oubli de matériel géométrique",
        "Oubli de feuille"
      ]
    };

    // 1) génération des 30 sous-cases
    const casesContainer = document.getElementById('cases');
    let num = 1;
    for (let row = 0; row < 5; row++) {
      for (let col = 0; col < 3; col++) {
        const container = document.createElement('div');
        container.className = 'case-container';
        for (let half = 0; half < 2; half++) {
          const sc = document.createElement('div');
          sc.className = 'subcase';
          sc.dataset.case = num;

          // entête : toggle + titre
          const header = document.createElement('div');
          header.className = 'header';
          const toggle = document.createElement('input');
          toggle.type = 'checkbox';
          toggle.className = 'toggle';
          toggle.dataset.case = num;
          const title = document.createElement('span');
          title.className = 'title';
          title.textContent = `Case ${num}`;
          header.append(toggle, title);
          sc.append(header);

          // options
          const opts = document.createElement('div');
          opts.className = 'options';
          ["Comportement","Travail non fait","Oubli de matériel"].forEach(cat => {
            const lbl = document.createElement('label');
            const inp = document.createElement('input');
            inp.type = 'checkbox';
            inp.dataset.case = num;
            inp.value = cat;
            lbl.append(inp, ' ' + cat);
            opts.append(lbl, document.createElement('br'));
          });
          sc.append(opts);

          container.append(sc);
          num++;
        }
        casesContainer.append(container);
      }
    }

    // 2) clic sur sous-case (hors checkbox) → sélection verte
    document.querySelectorAll('.subcase').forEach(sc => {
      sc.addEventListener('click', e => {
        if (e.target.tagName === 'INPUT') return;
        sc.classList.toggle('selected');
      });
    });

    // 3) toggle → afficher/masquer les options
    document.querySelectorAll('.toggle').forEach(toggle => {
      toggle.addEventListener('change', function() {
        const sc = this.closest('.subcase');
        const opts = sc.querySelector('.options');
        if (this.checked) opts.style.display = 'block';
        else {
          opts.style.display = 'none';
          opts.querySelectorAll('input[type=checkbox]')
            .forEach(cb => cb.checked && removeResult(cb.dataset.case, cb.value) && (cb.checked = false));
        }
      });
    });

    // 4) infractions cochées
    document.querySelectorAll('.options input[type="checkbox"]').forEach(cb => {
      cb.addEventListener('change', function() {
        const c = this.dataset.case;
        this.checked ? addResult(c, this.value) : removeResult(c, this.value);
      });
    });

    const resultList = document.getElementById('result-list');
    function addResult(c, v) {
      const id = `result-${c}-${v}`;
      if (!document.getElementById(id)) {
        const li = document.createElement('li');
        li.id = id;
        li.textContent = `case n°${c} : ${v}`;
        resultList.append(li);
      }
    }
    function removeResult(c, v) {
      const el = document.getElementById(`result-${c}-${v}`);
      if (el) {
        const next = el.nextElementSibling;
        if (next && (next.classList.contains('detail')||next.classList.contains('detail-select'))) next.remove();
        el.remove();
      }
    }

    // 5) clic sur infraction → afficher précisions
    resultList.addEventListener('click', e => {
      const li = e.target;
      if (li.tagName !== 'LI' || li.classList.contains('detail')||li.classList.contains('detail-select')) return;
      // retirer anciens détails
      const prev = resultList.querySelector('li.detail, li.detail-select');
      if (prev) prev.remove();

      const inf = li.textContent.split(' : ')[1];
      const opts = detailsOptions[inf] || ["Aucune précision"];

      if (inf === "Comportement") {
        // trois cases à cocher
        const selLi = document.createElement('li');
        selLi.className = 'detail-select';
        opts.forEach(opt => {
          const lbl = document.createElement('label');
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.value = opt;
          lbl.append(cb, ' ' + opt);
          selLi.append(lbl, document.createElement('br'));

          cb.addEventListener('change', () => {
            const detId = `detail-${li.id}-${opt}`;
            if (cb.checked) {
              const det = document.createElement('li');
              det.id = detId;
              det.className = 'detail';
              det.textContent = opt;
              li.insertAdjacentElement('afterend', det);
            } else {
              const det = document.getElementById(detId);
              if (det) det.remove();
            }
          });
        });
        li.insertAdjacentElement('afterend', selLi);

      } else if (opts.length > 1) {
        // reste via <select> + OK
        const selLi = document.createElement('li');
        selLi.className = 'detail-select';
        const sel = document.createElement('select');
        opts.forEach(o => {
          const op = document.createElement('option');
          op.value = o; op.text = o;
          sel.append(op);
        });
        const btn = document.createElement('button');
        btn.textContent = 'OK';
        selLi.append(sel, btn);
        li.insertAdjacentElement('afterend', selLi);
        btn.addEventListener('click', () => {
          const chosen = sel.value;
          selLi.remove();
          const det = document.createElement('li');
          det.className = 'detail';
          det.textContent = chosen;
          li.insertAdjacentElement('afterend', det);
        });

      } else {
        // unique détail
        const det = document.createElement('li');
        det.className = 'detail';
        det.textContent = opts[0];
        li.insertAdjacentElement('afterend', det);
      }
    });

    // 6) Lien → export JSON
    document.getElementById('lien-box').addEventListener('click', () => {
      const infractions = Array.from(
        resultList.querySelectorAll('li:not(.detail):not(.detail-select)')
      ).map(li => li.textContent);
      const lok = new Intl.DateTimeFormat('fr-FR',{
        timeZone:'Europe/Paris',year:'numeric',month:'2-digit',
        day:'2-digit',hour:'2-digit',minute:'2-digit'
      }).format(new Date());
      const [dp,tp] = lok.split(' ');
      const [jj,MM] = dp.split('/');
      const [hh,mm] = tp.split(':');
      const now = `${jj}-${MM}-${hh}h${mm}`;
      const subs = Array.from(document.querySelectorAll('.subcase'));
      const presCount = subs.filter(sc=>sc.classList.contains('selected')).length;
      const absList = subs.filter(sc=>!sc.classList.contains('selected'))
                          .map(sc=>`case n°${sc.dataset.case}`);
      const payload = {
        date: now + ' (Europe/Paris)',
        infractions,
        presents: presCount,
        absents: absList
      };
      const data = JSON.stringify(payload,null,2);
      const blob = new Blob([data],{type:'application/json'});
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      if ('download' in a) {
        a.href=url; a.download=`infractions_${now}.json`;
        document.body.append(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      } else {
        window.open(url);
        setTimeout(()=>URL.revokeObjectURL(url),1000);
      }
    });

    // 7) Appel terminé
    document.getElementById('appel-box').addEventListener('click', () => {
      const subs = Array.from(document.querySelectorAll('.subcase'));
      const pres = subs.filter(sc=>sc.classList.contains('selected'));
      const abs  = subs.filter(sc=>!sc.classList.contains('selected'));
      let html = `<p>Élèves présents : ${pres.length}</p><p>Élèves absents :</p>`;
      if (abs.length) abs.forEach(sc=>html+=`<p>case n°${sc.dataset.case}</p>`);
      else html += '<p>—</p>';
      document.getElementById('appel-result').innerHTML = html;
    });
  </script>
</body>
</html>
